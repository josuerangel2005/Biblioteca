CREATE OR REPLACE PROCEDURE P_ACTUALIZAR_DISPONIBILIDAD_LIBRO(p_id_libro INTEGER, OUT state BOOLEAN) 
LANGUAGE PLPGSQL
AS $$
DECLARE
  TIENE_PRESTAMOS_ACTIVOS BOOLEAN := FALSE;
  LIBRO_EXISTE BOOLEAN;
BEGIN

    SELECT EXISTS(SELECT 1 FROM LIBRO L WHERE L.ID_LIBRO = p_id_libro)
    INTO LIBRO_EXISTE;

    IF NOT LIBRO_EXISTE THEN
      RAISE NOTICE 'El libro con id % no existe', p_id_libro;
      state := FALSE;
      RETURN;
    END IF;

    SELECT EXISTS(
    SELECT 
      1
    FROM
      PRESTAMO P INNER JOIN PRESTAMO_LIBRO PL USING(ID_PRESTAMO)
    WHERE 
      PL.ID_LIBRO = p_id_libro AND P.ENTREGADO = FALSE
    )
    INTO TIENE_PRESTAMOS_ACTIVOS;

    IF TIENE_PRESTAMOS_ACTIVOS THEN
      UPDATE LIBRO SET DISPONIBLE = FALSE WHERE ID_LIBRO = p_id_libro;
    ELSE
      UPDATE LIBRO SET DISPONIBLE = TRUE WHERE ID_LIBRO = p_id_libro;
    END IF;

    state := TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error inesperado: %', SQLERRM;
    state := FALSE;
END;
$$;
